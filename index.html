<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restavo | Ù…Ù‚Ø§Ø±Ù†Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;400;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #fefef6; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù†Ø§Ø¹Ù… */
        }
        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: #59451b (Ø¨Ù†ÙŠ Ø¯Ø§ÙƒÙ†) */
        .brand-color {
            background-color: #59451b;
        }
        .brand-text {
            color: #59451b;
        }
        .icon-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            color: #59451b;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .icon-link:hover {
            background-color: #f0f0e8;
        }
        /* Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± */
        .animate-bounce > div:nth-child(2) { animation-delay: 150ms; }
        .animate-bounce > div:nth-child(3) { animation-delay: 300ms; }
    </style>
</head>
<body class="antialiased">

    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-3xl font-bold brand-text">Restavo</span>
                </div>
                
                <div class="flex items-center space-x-4 space-x-reverse">
                    
                    <div id="user-display" class="hidden sm:block text-sm text-gray-600 font-medium"></div>

                    <button id="favorites-toggle-btn" class="icon-link relative" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©">
                        <i data-lucide="heart" class="w-5 h-5"></i>
                        <span id="favorites-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-200">0</span>
                        <span class="text-sm hidden lg:inline">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
                    </button>

                    <a href="#" class="icon-link" aria-label="Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©">
                        <i data-lucide="calendar-check" class="w-5 h-5"></i>
                        <span class="text-sm hidden lg:inline">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</span>
                    </a>
                    
                    <button id="auth-action-btn" class="brand-color text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-[#4d3c16] transition duration-200 shadow-md flex items-center gap-1">
                        <!-- Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ø¨Ø± JavaScript -->
                    </button>
                </div>
                
            </div>
        </div>
    </nav>

    <header style="background-image: url('./images/commercial-ozone-generator.jpg.webp'); background-size: cover; background-position: center;" class="py-20 lg:py-32 flex items-center justify-center">
        <div class="bg-white bg-opacity-95 p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-4xl mx-4">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Ø§Ø¨Ø­Ø« ÙˆÙ‚Ø§Ø±Ù† Ø£ÙØ¶Ù„ Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</h1>
            
            <form id="search-form" class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                <div class="col-span-2 md:col-span-1">
                    <label for="city" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆØ¬Ù‡Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)</label>
                    <select id="city" name="city" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#59451b] focus:border-[#59451b]">
                        <option value="Dubai">Ø¯Ø¨ÙŠ</option>
                        <option value="Abu Dhabi">Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ</option>
                        <option value="Cairo">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                        <option value="Giza">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                        <option value="Aswan">Ø£Ø³ÙˆØ§Ù†</option>
                        <option value="Luxor">Ø§Ù„Ø£Ù‚ØµØ±</option>
                        <option value="Sharm El Sheikh">Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®</option>
                        <option value="Hurghada">Ø§Ù„ØºØ±Ø¯Ù‚Ø©</option>
                    </select>
                </div>
                
                <div class="col-span-1">
                    <label for="check_in" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆØµÙˆÙ„</label>
                    <input type="date" id="check_in" name="check_in" value="2025-12-01" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#59451b] focus:border-[#59451b]">
                </div>
                
                <div class="col-span-1">
                    <label for="check_out" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</label>
                    <input type="date" id="check_out" name="check_out" value="2025-12-05" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#59451b] focus:border-[#59451b]">
                </div>

                <div class="col-span-2 md:col-span-1">
                    <button type="submit" class="w-full brand-color hover:bg-[#4d3c16] text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.02]">
                        Ø§Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†
                    </button>
                </div>
                
                <input type="hidden" id="min_rating" name="min_rating" value="0.0">
            </form>
            
        </div>
    </header>
    
    <main class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        
        <section class="mb-12">
            <h2 class="text-2xl font-bold brand-text mb-4 flex items-center gap-2 border-b pb-2">
                 <i data-lucide="sparkles" class="w-6 h-6"></i>
                 Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ø§Ù„Ø£ÙƒØ«Ø± Ø¨Ø­Ø«Ø§Ù‹ (Recommended for you)
            </h2>
            <div id="popular-hotels-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <p class="text-center text-gray-500 col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹...</p>
            </div>
        </section>

        <div id="results-container">
            <h2 id="results-title" class="text-3xl font-extrabold text-gray-800 mb-8 border-b pb-3 hidden"></h2>
            
            <div id="hotel-cards-list">
                </div>

            <p id="initial-message" class="text-lg text-gray-600 text-center">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ù‡Ø© ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</p>
        </div>
    </main>

    <footer class="brand-color text-white p-6 mt-10">
        <div class="max-w-7xl mx-auto text-center text-sm">
            <p>&copy; 2024 Restavo - Ù…Ù‚Ø§Ø±Ù†Ø© Ø°ÙƒÙŠØ© Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</p>
        </div>
    </footer>
    
    <div id="favorites-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[100] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 h-[90vh] flex flex-col overflow-hidden animate-in fade-in-0 zoom-in-95">
            <div class="brand-color text-white p-4 flex justify-between items-center rounded-t-xl flex-shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                    <span id="favorites-title">ÙÙ†Ø§Ø¯Ù‚Ùƒ Ø§Ù„Ù…ÙØ¶Ù„Ø© (0)</span>
                </h3>
                <button id="favorites-close-btn" class="hover:bg-[#4d3c16] p-1 rounded-full transition duration-150" aria-label="Ø£ØºÙ„Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="favorites-list" class="flex-grow p-4 space-y-4 overflow-y-auto">
                <p class="text-center text-gray-500 mt-10">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù‘ÙÙ„Ø§Øª...</p>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[100] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 animate-in fade-in-0 zoom-in-95">
            <div class="brand-color text-white p-4 flex justify-between items-center rounded-t-xl flex-shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="user-plus" class="w-6 h-6 fill-current"></i>
                    <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
                </h3>
                <button id="auth-close-btn" class="hover:bg-[#4d3c16] p-1 rounded-full transition duration-150" aria-label="Ø£ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-8">
                <form id="auth-form">
                    
                    <div class="flex justify-center mb-6">
                        <button type="button" id="login-tab" class="px-6 py-2 border-b-2 border-brand-color text-brand-text font-bold transition duration-200">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                        <button type="button" id="register-tab" class="px-6 py-2 border-b-2 border-gray-200 text-gray-500 hover:border-brand-color hover:text-brand-text transition duration-200">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                    </div>

                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="email" name="email" required 
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#59451b] focus:border-[#59451b]" 
                               placeholder="example@email.com">
                    </div>
                    
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="password" name="password" required minlength="6"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#59451b] focus:border-[#59451b]" 
                               placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    </div>
                    
                    <button type="submit" id="auth-submit-btn" class="w-full brand-color hover:bg-[#4d3c16] text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                    
                    <p id="auth-error-message" class="text-center text-red-500 text-sm mt-3 hidden"></p>

                    <div class="mt-6 text-center text-gray-500 text-sm">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø±:</div>
                    <div class="flex justify-center gap-4 mt-3">
                        <button type="button" class="flex items-center gap-2 border border-gray-300 p-2 rounded-lg hover:bg-gray-50 transition duration-150">
                            <i data-lucide="mail" class="w-5 h-5 text-red-500"></i>
                            <span class="text-sm hidden sm:inline">Ø¬ÙˆØ¬Ù„</span>
                        </button>
                        <button type="button" class="flex items-center gap-2 border border-gray-300 p-2 rounded-lg hover:bg-gray-50 transition duration-150">
                            <i data-lucide="facebook" class="w-5 h-5 text-blue-600"></i>
                            <span class="text-sm hidden sm:inline">ÙÙŠØ³Ø¨ÙˆÙƒ</span>
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
    <button id="chat-toggle-btn" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-2xl transition duration-300 z-50 transform hover:scale-110" aria-label="Ø§ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©">
        <i data-lucide="message-square-text" class="w-6 h-6"></i>
    </button>

    <div id="chat-window" class="fixed bottom-20 right-6 w-80 md:w-96 h-[400px] bg-white rounded-xl shadow-2xl border border-gray-200 z-50 flex flex-col hidden overflow-hidden">
        <div class="brand-color text-white p-4 flex justify-between items-center rounded-t-xl">
            <h3 class="text-lg font-bold">Ù…Ø³Ø§Ø¹Ø¯ Restavo Ø§Ù„Ø°ÙƒÙŠ</h3>
            <button id="chat-close-btn" class="hover:bg-[#4d3c16] p-1 rounded-full transition duration-150" aria-label="Ø£ØºÙ„Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto" dir="rtl">
            </div>
        
        <div class="p-4 border-t border-gray-200 flex gap-2">
            <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-[#59451b] focus:border-[#59451b]" dir="rtl">
            <button id="chat-send-btn" class="brand-color text-white p-2 rounded-lg hover:bg-[#4d3c16] transition duration-200 disabled:opacity-50" disabled>
                <i data-lucide="send" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <script type="module">
        // ----------------------------------------------------------------------
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        // ----------------------------------------------------------------------
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        let currentUser = null; // {id, username}
        let userFavorites = {}; // ÙƒØ§Ø¦Ù† Ù„ØªØ®Ø²ÙŠÙ† Ù…ÙØ¶Ù‘Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹ {hotelName: true}
        let authMode = 'login'; // 'login' or 'register'
        let pendingBookingData = null; // ğŸŒŸ NEW: Ù„ØªØ®Ø²ÙŠÙ† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø¹Ù„Ù‚

        // ----------------------------------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        // ----------------------------------------------------------------------
        const authModal = document.getElementById('auth-modal');
        function openAuthModal() {
            if (authModal) {
                authModal.classList.remove('hidden');
                // Ø¯Ø§Ø¦Ù…Ø§ Ø§Ø¨Ø¯Ø£ Ø¨ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ù…Ù† Ø²Ø± Ø§Ù„Ø­Ø¬Ø²
                authMode = 'login'; 
                updateAuthModalState();
                document.getElementById('email').focus();
            }
        }

        function closeAuthModal() {
             if (authModal) {
                authModal.classList.add('hidden');
            }
        }
        
        // ----------------------------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Gemini)
        // (Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡)
        // ----------------------------------------------------------------------
        let CHAT_HISTORY = [{ 
            role: "model", 
            parts: [{ 
                text: "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Restavo. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙØ¶Ù„ ÙˆØ¬Ù‡Ø©ØŒ Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø­Ø¬ÙˆØ²Ø§ØªÙƒØŒ Ø£Ùˆ ÙˆØ¬Ù‡Ø§Øª Ø§Ù„Ø³ÙØ±!" 
            }] 
        }];
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = "AIzaSyBgYtyJNrwvZ31_sZ4oxAdNyoD3L3Ee9G8";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
        const SYSTEM_INSTRUCTION = "You are a helpful and friendly travel and hotel booking assistant named Restavo AI. Your goal is to help the user find information about hotels, destinations, travel planning, and booking comparisons. Be concise, enthusiastic, and provide relevant information in Arabic. Do not mention that you are an LLM or an AI model.";

        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) {
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error('Max retries reached.');
        }

        async function callGeminiApi() {
            const payload = {
                contents: CHAT_HISTORY,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION }]
                },
            };

            try {
                const response = await fetchWithBackoff(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const modelText = candidate.content.parts[0].text;
                    CHAT_HISTORY.push({
                        role: "model",
                        parts: [{ text: modelText }]
                    });
                } else {
                    console.error("Gemini API returned an error or empty content:", result);
                    const errorText = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                    CHAT_HISTORY.push({ role: "model", parts: [{ text: errorText }] });
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                const errorText = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.";
                CHAT_HISTORY.push({ role: "model", parts: [{ text: errorText }] });
            } finally {
                document.getElementById('chat-input').disabled = false;
                document.getElementById('chat-send-btn').disabled = false;
                renderChat();
            }
        }

        function sendMessage() {
            const inputElement = document.getElementById('chat-input');
            const message = inputElement.value.trim();

            if (message === "") return;

            inputElement.disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
            inputElement.value = '';

            CHAT_HISTORY.push({
                role: "user",
                parts: [{ text: message }]
            });

            renderChat(true);
            callGeminiApi();
        }

        function renderChat(isLoading = false) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';

            CHAT_HISTORY.forEach(message => {
                const text = message.parts[0].text;
                const isUser = message.role === 'user';
                
                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="p-3 rounded-xl max-w-[80%] shadow-md ${isUser 
                            ? 'bg-blue-500 text-white rounded-bl-sm' 
                            : 'bg-gray-100 text-gray-800 rounded-tr-sm'}">
                            ${text}
                        </div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            });

            if (isLoading) {
                const loadingHtml = `
                    <div class="flex justify-start" id="loading-indicator">
                        <div class="bg-gray-100 text-gray-800 p-3 rounded-xl rounded-tr-sm max-w-[80%] shadow-md">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce delay-150"></div>
                                <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce delay-300"></div>
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', loadingHtml);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ----------------------------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        // ----------------------------------------------------------------------
        window.bookHotel = async (hotelName, city, checkIn, checkOut, price) => {
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¯Ø®ÙˆÙ„Ù‡
            if (currentUser) {
                const bookingData = {
                    hotel_name: hotelName,
                    city: city,
                    check_in: checkIn,
                    check_out: checkOut,
                    price: price,
                    hotel_image_url: `https://placehold.co/150x150/f0f0f0/333?text=${encodeURIComponent(city.replace(/\s/g, '+'))}`
                };

                try {
                    // Ù†Ø³ØªØ®Ø¯Ù… `credentials: 'include'` Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¬Ù„Ø³Ø©
                    const response = await fetch(`${API_BASE_URL}/booking`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include', 
                        body: JSON.stringify(bookingData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ ÙŠØ§ ${currentUser.username} ÙÙŠ ${hotelName} Ø¨Ù†Ø¬Ø§Ø­!`);
                        console.log("Booking Confirmed:", result);
                    } else {
                        alert(`âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø²: ${result.message}`);
                    }
                } catch (error) {
                    alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ø¬Ø². ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨ØªØ´ØºÙŠÙ„ 'python app.py' ÙˆØ£Ù† Flask ÙŠØ¹Ù…Ù„.");
                    console.error("Network Error during booking:", error);
                }

            } else {
                // ğŸŒŸ NEW: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¯Ø®ÙˆÙ„Ù‡ØŒ Ù†Ø®Ø²Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² ÙˆÙ†Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                pendingBookingData = {
                    hotel_name: hotelName,
                    city: city,
                    check_in: checkIn,
                    check_out: checkOut,
                    price: price
                };
                
                openAuthModal();
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø­Ø¬Ø²Ùƒ.");
            }
        };

        // ----------------------------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth Logic) - ÙŠØªÙØ§Ø¹Ù„ Ø§Ù„Ø¢Ù† Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
        // ----------------------------------------------------------------------
        function updateAuthModalState() {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const submitBtn = document.getElementById('auth-submit-btn');

            if (authMode === 'login') {
                loginTab.classList.add('border-brand-color', 'text-brand-text', 'font-bold');
                loginTab.classList.remove('border-gray-200', 'text-gray-500');
                registerTab.classList.remove('border-brand-color', 'text-brand-text', 'font-bold');
                registerTab.classList.add('border-gray-200', 'text-gray-500');
                submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            } else { // register
                registerTab.classList.add('border-brand-color', 'text-brand-text', 'font-bold');
                registerTab.classList.remove('border-gray-200', 'text-gray-500');
                loginTab.classList.remove('border-brand-color', 'text-brand-text', 'font-bold');
                loginTab.classList.add('border-gray-200', 'text-gray-500');
                submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
            }
        }

        async function handleAuthSubmission() {
            const username = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('auth-error-message');
            const submitBtn = document.getElementById('auth-submit-btn');
            
            errorMsg.textContent = '';
            errorMsg.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

            if (username === "" || password === "") {
                errorMsg.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
                errorMsg.classList.remove('hidden');
                submitBtn.disabled = false;
                updateAuthModalState();
                return;
            }

            const endpoint = authMode === 'login' ? '/login' : '/register';
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Ù†Ø³ØªØ®Ø¯Ù… `credentials: 'include'` Ù„Ø­ÙØ¸ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¬Ù„Ø³Ø©
                    credentials: 'include', 
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok) {
                    if (authMode === 'login') {
                        alert(result.message);
                        currentUser = { id: result.user_id, username: result.username };
                        updateUserUI();
                        closeAuthModal();

                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø­Ø¬Ø² Ù…Ø¹Ù„Ù‚ØŒ Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ°Ù‡ Ø§Ù„Ø¢Ù†
                        if (pendingBookingData) {
                            alert(`Ø¬Ø§Ø±ÙŠ Ø¥ØªÙ…Ø§Ù… Ø­Ø¬Ø²Ùƒ ÙÙŠ ${pendingBookingData.hotel_name}...`);
                            await window.bookHotel(
                                pendingBookingData.hotel_name,
                                pendingBookingData.city,
                                pendingBookingData.check_in,
                                pendingBookingData.check_out,
                                pendingBookingData.price
                            );
                            pendingBookingData = null; // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                        }
                    } else { // register
                        alert(result.message);
                        // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­ØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        authMode = 'login';
                        updateAuthModalState();
                    }
                } else {
                    errorMsg.textContent = result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.';
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                errorMsg.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                if (authMode === 'register' && !errorMsg.textContent) {
                    // Ù„Ø§ ØªØºÙŠØ± Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ø§Ø¬Ø­Ù‹Ø§
                } else {
                    updateAuthModalState();
                }
            }
        }

        async function handleLogout() {
            try {
                const response = await fetch(`${API_BASE_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await response.json();
                alert(result.message);
                currentUser = null;
                updateUserUI();
            } catch (error) {
                alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/status`, { credentials: 'include' });
                const result = await response.json();
                if (result.is_authenticated) {
                    currentUser = { id: result.user_id, username: result.username };
                } else {
                    currentUser = null;
                }
                updateUserUI();
            } catch (error) {
                console.error("Could not check login status:", error);
                currentUser = null;
                updateUserUI();
            }
        }

        function updateUserUI() {
            const userDisplay = document.getElementById('user-display');
            const authBtn = document.getElementById('auth-action-btn');

            if (currentUser) {
                userDisplay.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹, ${currentUser.username}`;
                userDisplay.classList.remove('hidden');
                authBtn.innerHTML = `<i data-lucide="log-out" class="w-4 h-4"></i><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>`;
                authBtn.onclick = handleLogout;
            } else {
                userDisplay.classList.add('hidden');
                authBtn.innerHTML = `<i data-lucide="user-plus" class="w-4 h-4"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span>`;
                authBtn.onclick = openAuthModal;
            }
            lucide.createIcons();
        }

        // ----------------------------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙØ¶Ù‘ÙÙ„Ø§Øª (Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§ØµØ©) - ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡
        // ----------------------------------------------------------------------
       // ----------------------------------------------------------------------
// Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙØ¶Ù‘ÙÙ„Ø§Øª (Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§ØµØ©) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Flask/SQLite
// ----------------------------------------------------------------------
window.toggleFavorite = async (hotelName, city, cardElement) => {
    // ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù„Ù… ÙŠØ¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ 'userId' Ù…Ù† Firebase.
    // Ø¨Ù„ ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù†Ø¸Ø§Ù… Flask-Login ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯.
    // Ù„ÙƒÙ† Ù…Ø¤Ù‚ØªØ§Ù‹ØŒ Ø³Ù†Ø¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† userId ÙØ§Ø±ØºØ§Ù‹ (Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙØ¶ÙŠÙ„).

    if (!userId) { // Ù„Ø§ Ù†Ø²Ø§Ù„ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ userId Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Firebase ÙÙ‚Ø· Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        openAuthModal();
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ø¥Ø¶Ø§ÙØ© Ù…ÙØ¶Ù„Ø©. (Ù…Ø­Ø§ÙƒØ§Ø©)");
        return;
    }
    
    const isCurrentlyFavorite = userFavorites[hotelName] || false;
    
    // ğŸŒŸ NEW: Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ POST Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© Flask
    try {
        const response = await fetch('http://127.0.0.1:5000/api/favorites/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ item_name: hotelName, city: city })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Flask
            userFavorites[hotelName] = result.is_favorite;
            updateFavoriteButton(cardElement, result.is_favorite);
            
            // ğŸŒŸ NEW: ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
            fetchAndRenderFavorites();

        } else if (response.status === 401) {
            // ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - ÙŠØ¬Ø¨ Ø£Ù† ØªØ¹ÙˆØ¯ 401 Ù…Ù† @login_required
            openAuthModal();
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ù…ÙØ¶Ù„Ø©.");
        } else {
            alert(`âŒ ÙØ´Ù„ Ø§Ù„ØªÙØ¶ÙŠÙ„: ${result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
            console.error("Favorite Toggle Failed:", result);
        }

    } catch (error) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ 'python app.py'.");
        console.error("Network Error during favorite toggle:", error);
    }
};
// ...
// ... (Ø¯Ø§Ø®Ù„ Ù…Ù„Ù index.html)

// ----------------------------------------------------------------------
// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯Ø§Ù„Ø© setupFavoritesListener Ùˆ renderFavoritesList Ø¬Ø²Ø¦ÙŠØ§Ù‹
// ----------------------------------------------------------------------

async function fetchAndRenderFavorites() {
    const favoritesListContainer = document.getElementById('favorites-list');
    const favoritesCountElement = document.getElementById('favorites-count');
    const favoritesTitleElement = document.getElementById('favorites-title');
    
    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    favoritesListContainer.innerHTML = '<p class="text-center text-gray-500 mt-10">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù‘ÙÙ„Ø§Øª...</p>';
    favoritesCountElement.textContent = '0';
    favoritesCountElement.classList.add('opacity-0');
    favoritesTitleElement.textContent = `ÙÙ†Ø§Ø¯Ù‚Ùƒ Ø§Ù„Ù…ÙØ¶Ù„Ø© (0)`;

    if (!userId) { // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø­Ø§ÙƒØ§Ø©)
         favoritesListContainer.innerHTML = `
            <div class="text-center p-10 bg-gray-50 rounded-lg">
                <i data-lucide="lock" class="w-12 h-12 text-red-400 mx-auto mb-4"></i>
                <p class="text-lg text-gray-600">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ù…ÙØ¶Ù‘ÙÙ„Ø§ØªÙƒ.</p>
            </div>
        `;
        lucide.createIcons();
        return;
    }
    
    try {
        const response = await fetch('http://127.0.0.1:5000/api/favorites', {
            method: 'GET',
            headers: {
                // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¶Ø§ÙØ© Header Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ
            }
        });

        if (response.status === 401) {
             favoritesListContainer.innerHTML = '<p class="text-center text-red-500 mt-10">ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>';
             return;
        }

        const favoritesData = await response.json();
        
        // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
        const newFavorites = {};
        favoritesData.forEach(fav => {
            newFavorites[fav.item_name] = { city: fav.city };
        });
        userFavorites = newFavorites; // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ
        
        // ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ø§Ù„Ù…Ø­Ø§ÙƒÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
        const favoriteHotels = SIMULATED_HOTELS.filter(hotel => userFavorites[hotel.name]);

        // ... Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¶ (renderFavoritesList) ...
        favoritesListContainer.innerHTML = ''; // Ù…Ø³Ø­ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        
        const count = favoriteHotels.length;
        favoritesCountElement.textContent = count;
        favoritesTitleElement.textContent = `ÙÙ†Ø§Ø¯Ù‚Ùƒ Ø§Ù„Ù…ÙØ¶Ù„Ø© (${count})`;
        favoritesCountElement.classList.toggle('opacity-0', count === 0);

        if (count === 0) {
            favoritesListContainer.innerHTML = `
                <div class="text-center p-10 bg-gray-50 rounded-lg">
                    <i data-lucide="heart-crack" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <p class="text-lg text-gray-600">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ÙÙ†Ø¯Ù‚ Ù„Ù„Ù…ÙØ¶Ù„Ø© Ø¨Ø¹Ø¯.</p>
                    <p class="text-sm text-gray-500 mt-2">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù„Ø¨ Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§.</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        favoriteHotels.forEach(hotel => {
            // ... (Ù†ÙØ³ ÙƒÙˆØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© HTML Ù‡Ù†Ø§) ...
            const cardHtml = `
                <div class="bg-white p-4 rounded-lg shadow-lg border border-gray-200 flex items-center justify-between">
                    <div class="flex items-start gap-4">
                        <img src="${hotel.image_url}" alt="ØµÙˆØ±Ø© ${hotel.name}" class="rounded-md w-16 h-16 object-cover flex-shrink-0">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">${hotel.name}</h4>
                            <p class="text-sm text-gray-500">${hotel.city} | ${hotel.rating} Ù†Ø¬ÙˆÙ…</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-end gap-2">
                        <button class="favorite-btn text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150"
                            onclick="toggleFavorite('${hotel.name.replace(/'/g, "\\'")}', '${hotel.city}', this.closest('.bg-white.p-4.rounded-lg.shadow-lg'))" aria-label="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©">
                            <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
                        </button>
                        <div class="text-xl font-extrabold text-green-600">$${hotel.cheapest_price}</div>
                    </div>
                </div>
            `;
            favoritesListContainer.insertAdjacentHTML('beforeend', cardHtml);
        });
        lucide.createIcons();
        
        // ğŸŒŸ NEW: Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        const searchForm = document.getElementById('search-form');
        if (searchForm) {
            searchForm.dispatchEvent(new Event('submit'));
        }

    } catch (error) {
        console.error("Error fetching favorites:", error);
        favoritesListContainer.innerHTML = '<p class="text-center text-red-500 mt-10">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù‘ÙÙ„Ø§Øª.</p>';
    }
}

// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯Ø§Ù„Ø© setupFavoritesListener Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
function setupFavoritesListener() {
    // Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø¨Ø§Ø´Ø±. Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ fetchAndRenderFavorites Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
    // (Ù…Ø«Ù„ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©)
    console.log("Favorites listener replaced by manual fetch.");
    fetchAndRenderFavorites(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
}

// ...
        // ----------------------------------------------------------------------
        // Ù…Ù†Ø·Ù‚ ØªØªØ¨Ø¹ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø© - ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡
        // ----------------------------------------------------------------------
        window.logSearchCount = async (hotelName) => {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø§Ù„Ø¢Ù†. ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø·Ù„Ø¨ Ù„Ù„Ø®Ø§Ø¯Ù… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«.
        };

        function setupPopularHotelsListener() {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø§Ù„Ø¢Ù†. ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø·Ù„Ø¨ Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….
            renderPopularHotels([]); // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
        }
        
        function renderPopularHotels(hotels) {
            const popularContainer = document.getElementById('popular-hotels-list');
            popularContainer.innerHTML = '';
            
            if (hotels.length === 0) {
                popularContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full mt-4">Ù…ÙŠØ²Ø© Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.</p>';
                return;
            }

            hotels.forEach(hotel => {
                const card = `
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-[#59451b] transition duration-200 hover:shadow-xl cursor-pointer" onclick="document.getElementById('city').value='${hotel.city}'; document.getElementById('search-form').dispatchEvent(new Event('submit'))">
                        <div class="flex items-center space-x-3 space-x-reverse">
                             <i data-lucide="trending-up" class="w-6 h-6 text-green-600 flex-shrink-0"></i>
                             <div>
                                <h4 class="text-base font-bold text-gray-800 truncate">${hotel.name}</h4>
                                <p class="text-xs text-gray-500">${hotel.city} - ${hotel.rating} Ù†Ø¬ÙˆÙ…</p>
                                <p class="text-xs text-gray-400">ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ${hotel.search_count} Ù…Ø±Ø§Øª</p>
                            </div>
                        </div>
                    </div>
                `;
                popularContainer.insertAdjacentHTML('beforeend', card);
            });
            lucide.createIcons();
        }

        // ----------------------------------------------------------------------
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø«
        // (Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡)
        // ----------------------------------------------------------------------
        const BOOKING_SITES = ["Booking.com", "Expedia", "Hotels.com", "Direct Hotel"];
        
        const RAW_HOTELS_DATA = [
            { name: "Grand View Towers", city: "Dubai", rating: 4.5, amenities: ["Ù…Ø³Ø¨Ø­", "ÙˆØ§ÙŠ ÙØ§ÙŠ Ù…Ø¬Ø§Ù†ÙŠ", "ØµØ§Ù„Ø© Ø±ÙŠØ§Ø¶ÙŠØ©"] },
            { name: "City Center Inn", city: "Dubai", rating: 3.8, amenities: ["ÙˆØ§ÙŠ ÙØ§ÙŠ Ù…Ø¬Ø§Ù†ÙŠ", "ÙØ·ÙˆØ± Ù…Ø¬Ø§Ù†ÙŠ"] },
            { name: "Luxury Resort Oasis", city: "Abu Dhabi", rating: 5.0, amenities: ["Ø´Ø§Ø·Ø¦ Ø®Ø§Øµ", "Ø³Ø¨Ø§", "Ù…Ø³Ø¨Ø­"] },
            { name: "The Budget Stay", city: "Abu Dhabi", rating: 3.0, amenities: ["Ù…ÙˆÙ‚Ù Ø³ÙŠØ§Ø±Ø§Øª", "ÙˆØ§ÙŠ ÙØ§ÙŠ Ù…Ø¬Ø§Ù†ÙŠ"] },
            { name: "Nile Panorama Hotel", city: "Cairo", rating: 4.2, amenities: ["Ø¥Ø·Ù„Ø§Ù„Ø© Ù†Ù‡Ø±ÙŠØ©", "Ù…Ø·Ø¹Ù…"] },
            { name: "Historical Boutique", city: "Cairo", rating: 4.0, amenities: ["ØªØ±Ø§Ø³", "ÙØ·ÙˆØ± Ù…Ø¬Ø§Ù†ÙŠ"] },
            { name: "Palm Beach Hotel", city: "Dubai", rating: 4.7, amenities: ["ÙˆØµÙˆÙ„ Ù„Ù„Ø´Ø§Ø·Ø¦", "Ù…Ø³Ø¨Ø­", "Ø³Ø¨Ø§"] },
            { name: "Desert Sands Villa", city: "Abu Dhabi", rating: 4.1, amenities: ["ØµØ§Ù„Ø© Ø±ÙŠØ§Ø¶ÙŠØ©", "ÙˆØ§ÙŠ ÙØ§ÙŠ Ù…Ø¬Ø§Ù†ÙŠ"] },
            { name: "Four Seasons Hotel Nile Plaza", city: "Cairo", rating: 4.9, amenities: ["Ø³Ø¨Ø§ ÙØ§Ø®Ø±", "Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙŠÙ„", "Ù…Ø³Ø¨Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø­"] },
            { name: "Marriott Mena House", city: "Giza", rating: 4.8, amenities: ["Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª", "Ø­Ø¯Ø§Ø¦Ù‚", "Ù…Ø·Ø¹Ù… ÙØ§Ø®Ø±"] },
            { name: "Sofitel Legend Old Cataract", city: "Aswan", rating: 5.0, amenities: ["ØªØ§Ø±ÙŠØ®ÙŠ", "Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙŠÙ„", "Ù…Ø³Ø¨Ø­", "Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø¬Ù†Ø­Ø©"] },
            { name: "Rixos Premium Seagate", city: "Sharm El Sheikh", rating: 4.6, amenities: ["Ø´Ø§Ù…Ù„ ÙƒÙ„ÙŠØ§Ù‹", "Ø£ÙƒÙˆØ§ Ø¨Ø§Ø±Ùƒ", "ÙˆØµÙˆÙ„ Ù„Ù„Ø´Ø§Ø·Ø¦"] },
            { name: "Hilton Luxor Resort & Spa", city: "Luxor", rating: 4.4, amenities: ["Ø³Ø¨Ø§", "Ø¥Ø·Ù„Ø§Ù„Ø© Ù†Ù‡Ø±ÙŠØ©", "Ù…Ø³Ø¨Ø­ Ø¥Ù†ÙÙŠÙ†ÙŠØªÙŠ"] },
            { name: "The Oberoi Sahl Hasheesh", city: "Hurghada", rating: 4.8, amenities: ["Ø£Ø¬Ù†Ø­Ø© ÙØ§Ø®Ø±Ø©", "Ø´Ø§Ø·Ø¦ Ø®Ø§Øµ", "ØºÙˆØµ"]},
        ];
        
        function generateSimulatedPrices(rating) {
            const basePriceFactor = parseInt(rating * 50); 
            const minBase = 150 + basePriceFactor;
            const maxBase = 450 + basePriceFactor;
            const basePrice = Math.floor(Math.random() * (maxBase - minBase + 1)) + minBase;
            const prices = {};
            for (const site of BOOKING_SITES) {
                const variation = Math.random() * (1.05 - 0.95) + 0.95; 
                prices[site] = Math.round(basePrice * variation);
            }
            return prices;
        }

        const SIMULATED_HOTELS = RAW_HOTELS_DATA.map(hotel => {
            const prices = generateSimulatedPrices(hotel.rating);
            let cheapestPrice = Infinity;
            let cheapestSite = "N/A";
            for (const site in prices) {
                if (prices[site] < cheapestPrice) {
                    cheapestPrice = prices[site];
                    cheapestSite = site;
                }
            }
            return {
                ...hotel,
                prices,
                cheapest_price: cheapestPrice,
                cheapest_site: cheapestSite,
                image_url: `https://placehold.co/150x150/f0f0f0/333?text=${encodeURIComponent(hotel.city.replace(/\s/g, '+'))}`
            };
        });

        function searchAndCompareDeals(city, minRating) {
            let matchingHotels = SIMULATED_HOTELS.filter(hotel => {
                const matchesCity = hotel.city.toLowerCase() === city.toLowerCase();
                const matchesRating = hotel.rating >= minRating;
                return matchesCity && matchesRating;
            });
            matchingHotels.sort((a, b) => a.cheapest_price - b.cheapest_price);
            
            if (currentUser) {
                 matchingHotels.forEach(hotel => logSearchCount(hotel.name));
            }
            
            return matchingHotels;
        }

        function renderResults(results, cityDisplay) {
            const titleElement = document.getElementById('results-title');
            const initialMessage = document.getElementById('initial-message');
            const cardsList = document.getElementById('hotel-cards-list'); 

            cardsList.innerHTML = '';
            
            if (initialMessage) {
                initialMessage.style.display = 'none';
            }

            if (results.length === 0) {
                titleElement.textContent = `Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ†Ø§Ø¯Ù‚ ÙÙŠ ${cityDisplay}`;
                titleElement.classList.remove('hidden');
                cardsList.innerHTML = `<p class="text-xl text-center mt-8 text-gray-500">Ù†Ø£Ø³ÙØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ${cityDisplay}.</p>`;
                return;
            }

            titleElement.textContent = `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ${cityDisplay} (${results.length} ÙÙ†Ø¯Ù‚)`;
            titleElement.classList.remove('hidden');
            
            results.forEach(hotel => {
                const isFavorite = userFavorites[hotel.name] || false;
                const favoriteClass = isFavorite ? 'text-red-500 fill-current' : 'text-gray-400';
                
                const amenitiesHtml = hotel.amenities.map(amenity => `
                    <span class="bg-gray-100 text-gray-700 text-xs font-semibold px-3 py-1 rounded-full shadow-sm">${amenity}</span>
                `).join('');

                let pricesHtml = '';
                for (const site in hotel.prices) {
                    pricesHtml += `
                        <div class="flex justify-between text-sm py-2 border-b last:border-b-0 border-gray-100 ${hotel.prices[site] === hotel.cheapest_price ? 'bg-green-50 font-bold' : ''}">
                            <span>${site}:</span>
                            <span class="text-right">$${hotel.prices[site]}</span>
                        </div>
                    `;
                }

                const hotelCardHtml = `
                    <div class="bg-white rounded-xl shadow-xl mb-6 overflow-hidden flex flex-col md:flex-row transform hover:shadow-2xl transition duration-300 border border-gray-100" id="card-${hotel.name.replace(/\s/g, '-')}">
                        
                        <div class="w-full md:w-56 flex-shrink-0 bg-gray-50 p-4 flex flex-col justify-between items-center text-center">
                            <img src="${hotel.image_url}" alt="ØµÙˆØ±Ø© ${hotel.name}" class="rounded-lg mb-3 w-28 h-28 object-cover border border-gray-200">
                            
                            <div class="p-2 w-full brand-color text-white font-extrabold text-xl rounded-lg shadow-md">
                                ${hotel.rating} <span class="text-sm font-normal">/ 5.0</span>
                            </div>
                        </div>

                        <div class="p-6 flex flex-col justify-between w-full">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-2">${hotel.name}</h3>
                                    <p class="text-sm text-gray-500 mb-4">${hotel.city}</p>
                                </div>
                                
                                <button class="favorite-btn p-2 rounded-full hover:bg-gray-100 transition duration-150 ${favoriteClass}"
                                    onclick="toggleFavorite('${hotel.name.replace(/'/g, "\\'")}', '${hotel.city}', this.closest('.bg-white.rounded-xl.shadow-xl.mb-6'))">
                                    <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                                </button>

                            </div>

                            <div class="flex flex-wrap gap-2 mb-4">${amenitiesHtml}</div>

                            <div class="mt-4 pt-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <div class="mb-4 sm:mb-0">
                                    <p class="text-lg font-medium text-gray-600">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ù„Ù„ÙŠÙ„Ø© ÙˆØ§Ø­Ø¯Ø©:</p>
                                    <p class="text-4xl font-extrabold text-green-600 mt-1">$${hotel.cheapest_price}</p>
                                    <p class="text-sm text-gray-500">Ù…ØªØ§Ø­ Ø¹Ù„Ù‰: <span class="font-semibold brand-text">${hotel.cheapest_site}</span></p>
                                </div>

                                <div class="flex gap-3 items-center">
                                    <div class="relative group/comparison">
                                        <button class="price-comparison-button brand-color hover:bg-[#4d3c16] text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-xl whitespace-nowrap">
                                            Ø¹Ø±Ø¶ ${Object.keys(hotel.prices).length} Ø¹Ø±Ø¶
                                        </button>
                                        
                                        <div class="comparison-details absolute z-10 w-64 p-4 bg-white rounded-xl shadow-2xl border border-gray-200 opacity-0 group-hover/comparison:opacity-100 group-hover/comparison:block transition duration-300 pointer-events-none group-hover/comparison:pointer-events-auto transform right-0 mt-3 -translate-y-2 group-hover/comparison:translate-y-0">
                                            <p class="text-base font-bold text-gray-700 mb-2 border-b pb-2">Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</p>
                                            ${pricesHtml}
                                        </div>
                                    </div>
                                    
                                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-xl whitespace-nowrap" 
                                        onclick="bookHotel(
                                            '${hotel.name.replace(/'/g, "\\'")}', 
                                            '${hotel.city}', 
                                            document.getElementById('check_in').value, 
                                            document.getElementById('check_out').value, 
                                            ${hotel.cheapest_price}
                                        )">
                                        Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù† ($${hotel.cheapest_price})
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                cardsList.insertAdjacentHTML('beforeend', hotelCardHtml);
            });
            lucide.createIcons();
        }

        // ----------------------------------------------------------------------
        // Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
        // ----------------------------------------------------------------------
        document.getElementById('search-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const cityInput = document.getElementById('city');
            const ratingInput = document.getElementById('min_rating');
            
            const selectedCity = cityInput.value;
            const minRating = parseFloat(ratingInput.value);

            const results = searchAndCompareDeals(selectedCity, minRating);
            
            renderResults(results, cityInput.options[cityInput.selectedIndex].text);
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await checkLoginStatus(); // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            
            const defaultCity = document.getElementById('city').value;
            const defaultRating = parseFloat(document.getElementById('min_rating').value);
            const initialResults = searchAndCompareDeals(defaultCity, defaultRating);
            renderResults(initialResults, document.getElementById('city').options[document.getElementById('city').selectedIndex].text);
            
            lucide.createIcons();
            
            // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©
            const favoritesToggleBtn = document.getElementById('favorites-toggle-btn');
            const favoritesCloseBtn = document.getElementById('favorites-close-btn');
            const favoritesModal = document.getElementById('favorites-modal');

            favoritesToggleBtn.addEventListener('click', () => {
                favoritesModal.classList.remove('hidden');
               fetchAndRenderFavorites(); // ğŸŒŸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ 
            });

            favoritesCloseBtn.addEventListener('click', () => {
                favoritesModal.classList.add('hidden');
            });
            
            // ğŸŒŸ ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„/ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const authCloseBtn = document.getElementById('auth-close-btn');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');

            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            authCloseBtn.addEventListener('click', closeAuthModal);
            
            loginTab.addEventListener('click', () => {
                authMode = 'login';
                updateAuthModalState();
            });
            
            registerTab.addEventListener('click', () => {
                authMode = 'register';
                updateAuthModalState();
            });
            
            document.getElementById('auth-form').addEventListener('submit', (event) => {
                event.preventDefault(); // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                handleAuthSubmission();
            });

            // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            chatToggleBtn.addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                if (!chatWindow.classList.contains('hidden')) {
                    renderChat();
                    chatInput.focus();
                }
            });

            chatCloseBtn.addEventListener('click', () => {
                chatWindow.classList.add('hidden');
            });

            // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            chatInput.addEventListener('input', () => {
                chatSendBtn.disabled = chatInput.value.trim() === '';
            });
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø²Ø±
            chatSendBtn.addEventListener('click', sendMessage);

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ù…ÙØªØ§Ø­ Enter
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !chatSendBtn.disabled) {
                    sendMessage();
                }
            });
            
            chatSendBtn.disabled = chatInput.value.trim() === '';

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Firebase
            setupFavoritesListener();
            setupPopularHotelsListener();
        });
    </script>
</body>
</html>